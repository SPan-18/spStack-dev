<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>spStack: Bayesian Geostatistics Using Predictive Stacking • spStack</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="spStack: Bayesian Geostatistics Using Predictive Stacking">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spStack</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/spStack.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/posterior-predictive.html">Posterior Predictive Inference</a></li>
    <li><a class="dropdown-item" href="../articles/spatial-temporal.html">Spatial-Temporal Regression Models</a></li>
    <li><a class="dropdown-item" href="../articles/spatial.html">Spatial Regression Models</a></li>
    <li><a class="dropdown-item" href="../articles/technical_overview.html">Technical Overview</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SPan-18/spStack-dev/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>spStack: Bayesian Geostatistics Using Predictive Stacking</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/SPan-18/spStack-dev/blob/v1.1.1/vignettes/spStack.Rmd" class="external-link"><code>vignettes/spStack.Rmd</code></a></small>
      <div class="d-none name"><code>spStack.Rmd</code></div>
    </div>

    
    
<p>spStack implements Bayesian inference for a rich class of spatial and
spatial-temporal geostatistical models using stacking of predictive
densities. Besides delivering competitive predictive performance as
compared to traditional fully Bayesian inference using MCMC, predictive
stacking is embarrassingly parallel, and hence, fast. This package, to
the best of our knowledge, is the first to implement stacking for
Bayesian analysis of spatial and spatial-temporal data. Technical
details surrounding the methodology can be found in the articles <span class="citation">Zhang, Tang, and Banerjee (<a href="#ref-zhang2024stacking">2025</a>)</span> and <span class="citation">Pan et al. (<a href="#ref-pan2024stacking">2025</a>)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1729</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="bayesian-gaussian-spatial-regression-models">Bayesian Gaussian spatial regression models<a class="anchor" aria-label="anchor" href="#bayesian-gaussian-spatial-regression-models"></a>
</h2>
<p>Here is a quick example using the lazyloaded synthetic data
<code>simGaussian</code>.</p>
<p><strong>Step 1.</strong> Load the library spStack and prepare the
data. Here we split the data into <code>dat_train</code> and
<code>dat_pred</code> - we train our model on <code>dat_train</code> and
subsequently carry out posterior predictive inference at the locations
in <code>dat_pred</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://span-18.github.io/spStack-dev/">spStack</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># training and test data sizes</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">n_pred</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"simGaussian"</span><span class="op">)</span></span>
<span><span class="va">dat_train</span> <span class="op">&lt;-</span> <span class="va">simGaussian</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_train</span>, <span class="op">]</span></span>
<span><span class="va">dat_pred</span> <span class="op">&lt;-</span> <span class="va">simGaussian</span><span class="op">[</span><span class="va">n_train</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_pred</span>, <span class="op">]</span></span></code></pre></div>
<p><strong>Step 2.</strong> Run the function <code><a href="../reference/spLMstack.html">spLMstack()</a></code> -
define the model with a formula, input the spatial coordinates as a
matrix, specify the correlation function, and accordingly provide
candidate values of the parameters through <code>params.list</code>. The
argument <code>loopd.method</code> can be used to specify the method
used for calculation of leave-one-out predictive densities, existing
parallelization plan can be used if <code>parallel</code> is set
<code>TRUE</code>, and <code>solver</code> argument specifies the solver
used to carry out the optimization routine to get stacking weights.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spLMstack.html">spLMstack</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">dat_train</span>,</span>
<span>                  coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_train</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s1"</span>, <span class="st">"s2"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                  cor.fn <span class="op">=</span> <span class="st">"matern"</span>,</span>
<span>                  params.list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>                                     nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>, <span class="fl">1.25</span><span class="op">)</span>,</span>
<span>                                     noise_sp_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  n.samples <span class="op">=</span> <span class="fl">1000</span>, loopd.method <span class="op">=</span> <span class="st">"psis"</span>,</span>
<span>                  parallel <span class="op">=</span> <span class="cn">FALSE</span>, solver <span class="op">=</span> <span class="st">"ECOS"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; STACKING WEIGHTS:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            | phi | nu   | noise_sp_ratio | weight |</span></span>
<span><span class="co">#&gt; +----------+-----+------+----------------+--------+</span></span>
<span><span class="co">#&gt; | Model 1  |  1.5|  0.75|             0.5| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 2  |  3.0|  0.75|             0.5| 0.030  |</span></span>
<span><span class="co">#&gt; | Model 3  |  5.0|  0.75|             0.5| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 4  |  1.5|  1.25|             0.5| 0.287  |</span></span>
<span><span class="co">#&gt; | Model 5  |  3.0|  1.25|             0.5| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 6  |  5.0|  1.25|             0.5| 0.683  |</span></span>
<span><span class="co">#&gt; | Model 7  |  1.5|  0.75|             1.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 8  |  3.0|  0.75|             1.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 9  |  5.0|  0.75|             1.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 10 |  1.5|  1.25|             1.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 11 |  3.0|  1.25|             1.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 12 |  5.0|  1.25|             1.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 13 |  1.5|  0.75|             2.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 14 |  3.0|  0.75|             2.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 15 |  5.0|  0.75|             2.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 16 |  1.5|  1.25|             2.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 17 |  3.0|  1.25|             2.0| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 18 |  5.0|  1.25|             2.0| 0.000  |</span></span>
<span><span class="co">#&gt; +----------+-----+------+----------------+--------+</span></span></code></pre></div>
<p><strong>Step 3.</strong> Use the helper function
<code><a href="../reference/stackedSampler.html">stackedSampler()</a></code> to sample from the stacked posterior
distribution. These samples serve as the final posterior samples
corresponding to our target model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_samps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stackedSampler.html">stackedSampler</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span></code></pre></div>
<p>The final output will be a tagged list with each entry containing
posterior samples of the corresponding parameter.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_beta</span> <span class="op">&lt;-</span> <span class="va">post_samps</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="va">summary_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post_beta</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">summary_beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">mod1</span><span class="op">$</span><span class="va">X.names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summary_beta</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 2.5%      50%    97.5%</span></span>
<span><span class="co">#&gt; (Intercept) 1.074093 2.318164 3.193045</span></span>
<span><span class="co">#&gt; x1          4.848954 4.975130 5.094167</span></span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> The following optional steps are only required
if interested in posterior predictive inference.</p>
</blockquote>
<p><strong>(Optional) Step 4.</strong> Prepare the inputs for posterior
predictive inference. The new spatial coordinates at which we intend to
carry out prediction is given by <code>sp_pred</code> and the value of
the covariates at these new locations are given by
<code>X_new</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_pred</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s1"</span>, <span class="st">"s2"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_pred</span><span class="op">)</span>, <span class="va">dat_pred</span><span class="op">$</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>(Optional) Step 5.</strong> Pass the output obtained by
running <code><a href="../reference/spLMstack.html">spLMstack()</a></code> through the function
<code><a href="../reference/posteriorPredict.html">posteriorPredict()</a></code> along with the new coordinates and
covariates.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod.pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posteriorPredict.html">posteriorPredict</a></span><span class="op">(</span><span class="va">mod1</span>,</span>
<span>                             coords_new <span class="op">=</span> <span class="va">sp_pred</span>,</span>
<span>                             covars_new <span class="op">=</span> <span class="va">X_new</span>,</span>
<span>                             joint <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><strong>(Optional) Step 6.</strong> Once samples from the posterior
predictive distribution are obtained, once again run
<code><a href="../reference/stackedSampler.html">stackedSampler()</a></code> to obtain samples from the
<em>stacked</em> posterior predictive distribution.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">postpred_samps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stackedSampler.html">stackedSampler</a></span><span class="op">(</span><span class="va">mod.pred</span><span class="op">)</span></span></code></pre></div>
<p>Next, we analyze how well we predict the responses by plotting their
posterior predictive summaries against their corresponding true
values.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">postpred_y</span> <span class="op">&lt;-</span> <span class="va">postpred_samps</span><span class="op">$</span><span class="va">y.pred</span></span>
<span><span class="va">post_y_summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">postpred_y</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y_combn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">dat_pred</span><span class="op">$</span><span class="va">y</span>, yL <span class="op">=</span> <span class="va">post_y_summ</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>                      yM <span class="op">=</span> <span class="va">post_y_summ</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, yU <span class="op">=</span> <span class="va">post_y_summ</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">y_combn</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">yL</span>, ymax <span class="op">=</span> <span class="va">yU</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"skyblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">yM</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkblue"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"True y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Posterior predictive of y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="spStack_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>More details about this can found in the vignettes titled “Spatial
Models” and “Posterior Predictive Inference”.</p>
</div>
<div class="section level2">
<h2 id="bayesian-non-gaussian-spatial-regression-models">Bayesian non-Gaussian spatial regression models<a class="anchor" aria-label="anchor" href="#bayesian-non-gaussian-spatial-regression-models"></a>
</h2>
<p>The workflow for the spatial generalized linear models are similar.
Here is a quick example using the lazyloaded synthetic data
<code>simPoisson</code>.</p>
<p><strong>Step 1.</strong> Prepare data by splitting into train and
test sets.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># training and test data sizes</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">n_pred</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="co"># load spatial Poisson data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"simPoisson"</span><span class="op">)</span></span>
<span><span class="va">dat_train</span> <span class="op">&lt;-</span> <span class="va">simPoisson</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n_train</span>, <span class="op">]</span></span>
<span><span class="va">dat_pred</span> <span class="op">&lt;-</span> <span class="va">simPoisson</span><span class="op">[</span><span class="va">n_train</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_pred</span>, <span class="op">]</span></span></code></pre></div>
<p><strong>Step 2.</strong> Run the function <code><a href="../reference/spGLMstack.html">spGLMstack()</a></code>
after specifying the <code>family</code>, and supplying the candidate
values of the spatial process parameters <code>phi</code> and
<code>nu</code>, and the boundary adjustment parameter
<code>boundary</code>. The <code>loopd.controls</code> option can be
used to specify the method and parameters used for calculation of
leave-one-out predictive densities. The input
<code>list(method = "CV", CV.K = 10, nMC = 500)</code> corresponds to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>K</mi><annotation encoding="application/x-tex">K</annotation></semantics></math>-fold
cross-validation with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">K = 10</annotation></semantics></math>
and using 500 Monte Carlo samples for calculating each predictive
density.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spGLMstack.html">spGLMstack</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span>, data <span class="op">=</span> <span class="va">dat_train</span>, family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>                   coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_train</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s1"</span>, <span class="st">"s2"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, cor.fn <span class="op">=</span> <span class="st">"matern"</span>,</span>
<span>                   params.list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span>, nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.0</span><span class="op">)</span>,</span>
<span>                                      boundary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                   priors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nu.beta <span class="op">=</span> <span class="fl">5</span>, nu.z <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>                   n.samples <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                   loopd.controls <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"CV"</span>, CV.K <span class="op">=</span> <span class="fl">10</span>, nMC <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>,</span>
<span>                   verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Some priors were not supplied. Using defaults.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; STACKING WEIGHTS:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           | phi | nu  | boundary | weight |</span></span>
<span><span class="co">#&gt; +---------+-----+-----+----------+--------+</span></span>
<span><span class="co">#&gt; | Model 1 |    3|  0.5|       0.5| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 2 |    4|  0.5|       0.5| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 3 |    5|  0.5|       0.5| 0.000  |</span></span>
<span><span class="co">#&gt; | Model 4 |    3|  1.0|       0.5| 0.115  |</span></span>
<span><span class="co">#&gt; | Model 5 |    4|  1.0|       0.5| 0.357  |</span></span>
<span><span class="co">#&gt; | Model 6 |    5|  1.0|       0.5| 0.528  |</span></span>
<span><span class="co">#&gt; +---------+-----+-----+----------+--------+</span></span></code></pre></div>
<p><strong>Step 3.</strong> Run <code><a href="../reference/stackedSampler.html">stackedSampler()</a></code> to obtain
posterior samples from the stacked posterior and then analyze the
output.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_samps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stackedSampler.html">stackedSampler</a></span><span class="op">(</span><span class="va">mod1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">post_beta</span> <span class="op">&lt;-</span> <span class="va">post_samps</span><span class="op">$</span><span class="va">beta</span></span>
<span><span class="va">summary_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">post_beta</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">summary_beta</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">mod1</span><span class="op">$</span><span class="va">X.names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summary_beta</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   2.5%        50%      97.5%</span></span>
<span><span class="co">#&gt; (Intercept)  0.8915484  2.0784747  3.3153751</span></span>
<span><span class="co">#&gt; x1          -0.6754765 -0.5677041 -0.4517785</span></span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> The following optional steps are only required
if interested in posterior predictive inference.</p>
</blockquote>
<p><strong>(Optional) Step 4.</strong> Prepare the inputs for posterior
predictive inference.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">dat_pred</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s1"</span>, <span class="st">"s2"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_pred</span><span class="op">)</span>, <span class="va">dat_pred</span><span class="op">$</span><span class="va">x1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>(Optional) Step 5.</strong> Finally, pass the model output
through the function <code><a href="../reference/posteriorPredict.html">posteriorPredict()</a></code></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod.pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posteriorPredict.html">posteriorPredict</a></span><span class="op">(</span><span class="va">mod1</span>,</span>
<span>                             coords_new <span class="op">=</span> <span class="va">sp_pred</span>,</span>
<span>                             covars_new <span class="op">=</span> <span class="va">X_new</span>,</span>
<span>                             joint <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><strong>(Optional) Step 6.</strong> Once samples from the posterior
predictive distribution is obtained, obtain samples from the stacked
posterior predictive distribution using
<code><a href="../reference/stackedSampler.html">stackedSampler()</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">postpred_samps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stackedSampler.html">stackedSampler</a></span><span class="op">(</span><span class="va">mod.pred</span><span class="op">)</span></span></code></pre></div>
<p>Further, we analyze the posterior predictive distribution of the
spatial process against their corresponding true values.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">postpred_z</span> <span class="op">&lt;-</span> <span class="va">postpred_samps</span><span class="op">$</span><span class="va">z.pred</span></span>
<span><span class="va">post_z_summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">postpred_z</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">z_combn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">dat_pred</span><span class="op">$</span><span class="va">z_true</span>, zL <span class="op">=</span> <span class="va">post_z_summ</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>                      zM <span class="op">=</span> <span class="va">post_z_summ</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, zU <span class="op">=</span> <span class="va">post_z_summ</span><span class="op">[</span>, <span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">z_combn</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">zL</span>, ymax <span class="op">=</span> <span class="va">zU</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"skyblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">zM</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkblue"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, intercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"True z"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Posterior predictive of z"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, aspect.ratio <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="spStack_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="additional-functionalities">Additional functionalities<a class="anchor" aria-label="anchor" href="#additional-functionalities"></a>
</h2>
<p>We have devised and demonstrated Bayesian predictive stacking to be
an effective tool for estimating spatial/spatial-temporal regression
models and yielding robust predictions for Gaussian as well as
non-Gaussian data. We develop and exploit analytically accessible
distribution theory pertaining to Bayesian analysis of linear mixed
model and generalized linear mixed models that enables us to directly
sample from the posterior distributions. The focus of this package is on
effectively combining inference across different closed-form posterior
distributions by circumventing inference on weakly identified
parameters.</p>
<p>The “Technical Overview” vignette provides a comprehensive review of
the conjugate Bayesian hierarchical models used here. The “Spatial
Models” and “Spatial-Temporal Models” explains in detail how to use the
functions for spatial and spatial-temporal regressions, respectively.
Future developments and investigations will consider zero-inflated
non-Gaussian data and adapting to variants of Gaussian process models
that scale inference to massive datasets by circumventing the Cholesky
decomposition of dense covariance matrices.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-pan2024stacking" class="csl-entry">
Pan, Soumyakanti, Lu Zhang, Jonathan R. Bradley, and Sudipto Banerjee.
2025. <span>“Bayesian Inference for Spatial-Temporal Non-Gaussian Data
Using Predictive Stacking.”</span> <a href="https://doi.org/10.48550/arXiv.2406.04655" class="external-link">https://doi.org/10.48550/arXiv.2406.04655</a>.
</div>
<div id="ref-zhang2024stacking" class="csl-entry">
Zhang, Lu, Wenpin Tang, and Sudipto Banerjee. 2025. <span>“Bayesian
Geostatistics Using Predictive Stacking.”</span> <a href="https://doi.org/10.48550/arXiv.2304.12414" class="external-link">https://doi.org/10.48550/arXiv.2304.12414</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Soumyakanti Pan, Sudipto Banerjee.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
